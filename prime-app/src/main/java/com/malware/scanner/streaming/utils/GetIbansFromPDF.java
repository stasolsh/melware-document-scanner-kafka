package com.malware.scanner.streaming.utils;

import com.malware.scanner.streaming.exception.ScannerTechnicalException;
import lombok.extern.log4j.Log4j2;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.text.PDFTextStripper;
import org.apache.pdfbox.text.TextPosition;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.net.URI;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Log4j2
public class GetIbansFromPDF extends PDFTextStripper {
    private static final Pattern IBAN_PATTERN = Pattern.compile("^([A-Z]{2}[ \\-]?[0-9]{2})(?=(?:[ \\-]?[A-Z0-9]){9,30}$)((?:[ \\-]?[A-Z0-9]{3,5}){2,7})([ \\-]?[A-Z0-9]{1,3})?$|\\b[A-Z]{2}[0-9]{2}(?:[ ]?[0-9]{4}){4}(?!(?:[ ]?[0-9]){3})(?:[ ]?[0-9]{1,2})?\\b");
    private static final List<String> LINES_WITH_IBANS = new ArrayList<>();

    public GetIbansFromPDF() throws IOException {
    }

    public static List<String> findIbans(String url) {
        log.info("GetLinesFromPDF.findIbans has to process url: " + url);
        List<String> IBANS = new ArrayList<>();
        try (PDDocument document = PDDocument.load(new File(URI.create(url)))) {
            configurePDFTextStripper(document);
            for (String line : LINES_WITH_IBANS) {
                Matcher m = IBAN_PATTERN.matcher(line);
                while (m.find()) {
                    IBANS.add(m.group(0).replaceAll("\\s", ""));
                }
            }
        } catch (IOException e) {
            log.error("Error while searching Ibans from .pdf file", e);
            throw new ScannerTechnicalException(String.format("Could not find Ibans in PDF file with url: %s", url), e);
        } finally {
            LINES_WITH_IBANS.clear();
        }
        return IBANS;
    }

    /**
     * Override the default functionality of PDFTextStripper.writeString()
     */
    @Override
    protected void writeString(String str, List<TextPosition> textPositions) {
        LINES_WITH_IBANS.add(str);
    }

    private static void configurePDFTextStripper(PDDocument document) throws IOException {
        PDFTextStripper stripper = new GetIbansFromPDF();
        stripper.setSortByPosition(true);
        stripper.setStartPage(0);
        stripper.setEndPage(document.getNumberOfPages());
        stripper.writeText(document, new OutputStreamWriter(new ByteArrayOutputStream()));
    }
}
